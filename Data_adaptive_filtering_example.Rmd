---
title: "Data-adaptive Filtering Example"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=F,warning=F,tidy = T,tidy.opts = list(width.cutoff=60),fig.show='hold',cache=T)
```

```{r libraries}

libs <- c('xcms','RColorBrewer','tidyverse','doParallel','foreach')
for (l in libs){
  suppressPackageStartupMessages(library(l,character.only=T))
}


```

### MD-plot filtering

```{r MD Filtering}

# log abundances from xcms pre-processing, without having used 'fillChromPeaks'
load('peakTable.RData')

# log abundances from xcms pre-processing after using 'fillChromPeaks'
load('filled_data.RData')

# CRC case status
load('cov.RData')

# list of good quality peaks, named 'pass'
load('good_quality_features.RData')

# list of poor quality peaks, names 'fail'
load('poor_quality_features.RData')



```

### Percent missing filtering

```{r percent missing filtering}

## calculate p-value for fisher exact test to evaluate dependence between case-control status and missing/non-missing for each feature
percent.zero <- apply(peakTable2[,obsNames1],1,function(x) mean(is.na(x)))

fish.pvals<- c()

for (i in 1:nrow(peakTable2)){
  if(percent.zero[i]==0 | percent.zero[i]==1){
    fish.pvals[i] <- 1
  } else{
    fish.pvals[i] <- fisher.test(as.numeric(is.na(peakTable2[i,obsNames1])),cov$Case)$p.value
  }
}



```

### ICC filtering

```{r ICC filtering}

```